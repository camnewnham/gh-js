<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFrameworks>net48;net8.0</TargetFrameworks>
    <Version>1.0</Version>
    <Title>Javascript for Grasshopper</Title>
    <Description>Javascript execution node for Grasshopper</Description>
    <TargetExt>.gha</TargetExt>
    <CopyLocalLockFileAssemblies>true</CopyLocalLockFileAssemblies>
    <AssemblyName>JavascriptForGrasshopper</AssemblyName>
    <RootNamespace>JavascriptForGrasshopper</RootNamespace>
    <LangVersion>9</LangVersion>
    <Platforms>mac-x64;mac-arm64;win-x64</Platforms>
    <PlatformTarget>AnyCPU</PlatformTarget>
  </PropertyGroup>

  <Choose>
    <When Condition="$(Platform.Contains('mac'))">
      <PropertyGroup>
        <DefineConstants>$(DefineConstants);RHINO_MAC</DefineConstants>
      </PropertyGroup>
      <ItemGroup>
        <None Update="native\osx-universal\libnode.dylib">
          <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
        </None>
      </ItemGroup>
    </When>
    
    <When Condition="$(Platform.Contains('win'))">
      <PropertyGroup>
        <DefineConstants>$(DefineConstants);RHINO_WIN</DefineConstants>
      </PropertyGroup>
      <ItemGroup>
        <None Update="native\win-x64\libnode.dll">
          <CopyToOutputDirectory>Always</CopyToOutputDirectory>
        </None>
      </ItemGroup>
    </When>
  </Choose>

  <Choose>
    <When Condition="$(Platform.Contains('arm64'))">
      <PropertyGroup>
        <DefineConstants>$(DefineConstants);RHINO_ARM64</DefineConstants>
      </PropertyGroup>
    </When>

    <When Condition="$(Platform.Contains('x64'))">
      <PropertyGroup>
        <DefineConstants>$(DefineConstants);RHINO_X64</DefineConstants>
      </PropertyGroup>
    </When>
  </Choose>

  <ItemGroup>
    <None Remove="Templates\index.ts" />
    <None Remove="Templates\package.json" />
    <None Remove="Templates\tsconfig.json" />
  </ItemGroup>

  <ItemGroup>
    <None Include="Templates\ts\.vscode\launch.json">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </None>
  </ItemGroup>

  <ItemGroup>
    <PackageReference Include="Grasshopper" Version="8.1.23325.13001" IncludeAssets="compile;build" />
    <PackageReference Include="Microsoft.JavaScript.NodeApi" Version="0.7.31" />
    <PackageReference Include="RhinoCommon" Version="8.1.23325.13001" />
    <PackageReference Include="System.CodeDom" Version="8.0.0" />
  </ItemGroup>


  <ItemGroup Condition="'$(TargetFramework)' == 'net48'">
    <Reference Include="System.Windows.Forms" />
  </ItemGroup>

  <ItemGroup Condition="'$(TargetFramework)' != 'net48'">
    <PackageReference Include="System.Drawing.Common" Version="8.0.7" />
    <PackageReference Include="System.Resources.Extensions" Version="8.0.0" />
    <PackageReference Include="Microsoft.WindowsDesktop.App.Ref" GeneratePathProperty="true" Version="8.0.0" ExcludeAssets="all" />
    <Reference Include="$(PkgMicrosoft_WindowsDesktop_App_Ref)\ref\net8.0\System.Windows.Forms.dll">
      <Private>False</Private>
    </Reference>
  </ItemGroup>

  <ItemGroup>
    <None Update="CodeGenerator\ComponentTypeGenerator.tt">
      <Generator>TextTemplatingFilePreprocessor</Generator>
      <LastGenOutput>ComponentTypeGenerator.cs</LastGenOutput>
    </None>
    <None Update="Templates\node\index.ts">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </None>
    <None Update="Templates\node\package.json">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </None>
    <None Update="Templates\node\tsconfig.json">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </None>
    <None Update="Templates\ts\index.ts">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </None>
    <None Update="Templates\ts\package.json">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </None>
    <None Update="Templates\ts\tsconfig.json">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </None>
    <None Update="Templates\ts\types\component.d.ts">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </None>
  </ItemGroup>

  <ItemGroup>
    <Service Include="{508349b6-6b84-4df5-91f0-309beebad82d}" />
  </ItemGroup>

  <ItemGroup>
    <Compile Update="Bundler.cs">
      <CopyToOutputDirectory>Never</CopyToOutputDirectory>
    </Compile>
    <Compile Update="Resources.Designer.cs">
      <DesignTime>True</DesignTime>
      <AutoGen>True</AutoGen>
      <DependentUpon>Resources.resx</DependentUpon>
    </Compile>
    <Compile Update="CodeGenerator\ComponentTypeGenerator.cs">
      <DesignTime>True</DesignTime>
      <AutoGen>True</AutoGen>
      <DependentUpon>ComponentTypeGenerator.tt</DependentUpon>
    </Compile>
  </ItemGroup>

  <ItemGroup>
    <EmbeddedResource Update="Resources.resx">
      <Generator>ResXFileCodeGenerator</Generator>
      <LastGenOutput>Resources.Designer.cs</LastGenOutput>
    </EmbeddedResource>
  </ItemGroup>


  <Target Name="NpmInstall" AfterTargets="CopyFilesToOutputDirectory">
    <Message Text="Fetching NPM modules" Importance="high" />
    <!-- Assumes a windows build machine-->
    <Exec Condition="$(Platform) == 'win-x64'" WorkingDirectory="$(OutDir)Templates\node" Command="npm run setup-win-x64" />
    <Exec Condition="$(Platform) == 'mac-arm64'" WorkingDirectory="$(OutDir)Templates\node" Command="npm run setup-mac-arm64" />
    <Exec Condition="$(Platform) == 'mac-x64'" WorkingDirectory="$(OutDir)Templates\node" Command="npm run setup-mac-x64" />
  </Target>
  
  <Target Name="CreateNodeScripts" AfterTargets="NpmInstall">
    <Message Text="TypeScript Compiling Templates/node" Importance="high" />
    <Exec WorkingDirectory="$(OutDir)Templates/node" Command="tsc" />
    <ItemGroup>
      <RemoveTypeScript Include="$(OutDir)Templates/node/tsconfig.json" />
      <RemoveTypeScript Include="$(OutDir)Templates/node/*.ts" />
      <RemoveTypeScript Include="$(OutDir)Templates/node/*.d.ts" />
    </ItemGroup>
    <Delete Files="@(RemoveTypeScript)" />
  </Target>

  <Target Name="CreateInitialBundle" AfterTargets="CopyFilesToOutputDirectory">
    <Message Text="Creating Templates/bundle/index.js" Importance="high" />
    <Exec WorkingDirectory="$(OutDir)Templates/ts" Command="npx -y esbuild index.* --outdir=../bundle --platform=node --bundle --minify" />
  </Target>

  <Target Name="CreateJSTemplate" AfterTargets="CopyFilesToOutputDirectory">
    <Message Text="Creating Template/js/*" Importance="high" />
    <Exec WorkingDirectory="$(OutDir)Templates/ts" Command="tsc --module es2022 --target es2022 --moduleResolution node --outdir ..\js" />
    <ItemGroup>
      <VSCodeFiles Include="$(OutDir)Templates/ts/.vscode/**" />
    </ItemGroup>
    <Copy SourceFiles="@(VSCodeFiles)" DestinationFolder="$(OutDir)Templates/js/.vscode/%(RecursiveDir)" />
  </Target>

  <Target Name="RegisterFileCleanUp" AfterTargets="CopyFilesToOutputDirectory;NpmInstall">
    <ItemGroup>
      <FileWrites Include="$(OutDir)Templates\**\*.*" />
    </ItemGroup>
  </Target>

</Project>